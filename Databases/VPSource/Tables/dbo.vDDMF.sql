CREATE TABLE [dbo].[vDDMF]
(
[Mod] [char] (2) COLLATE Latin1_General_BIN NOT NULL,
[Form] [varchar] (30) COLLATE Latin1_General_BIN NOT NULL
) ON [PRIMARY]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE TRIGGER [dbo].[vtDDMFd_Audit] ON [dbo].[vDDMF]
 AFTER DELETE
 NOT FOR REPLICATION AS
 SET NOCOUNT ON 
 -- generated by vspHQCreateAuditTriggers on May 14 2009  9:56AM

 BEGIN TRY 
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDMF' , '<KeyString Module = "' + REPLACE(CAST(deleted.Mod AS VARCHAR(MAX)),'"', '&quot;') + '" ModuleForm = "' + REPLACE(CAST(deleted.Form AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'D' , NULL , NULL , NULL , GETDATE() , HOST_NAME() , 'DELETE FROM vDDMF WHERE Mod = ''' + CAST(deleted.Mod AS VARCHAR(MAX)) + '''' + ' AND Form = ''' + CAST(deleted.Form AS VARCHAR(MAX)) + ''''
	FROM deleted
 END TRY 
 BEGIN CATCH 
   RAISERROR('Error in [dbo].[dbo.vtDDMFi_Audit] trigger', 16, 1 ) with log
 END CATCH 
GO
EXEC sp_settriggerorder N'[dbo].[vtDDMFd_Audit]', 'last', 'delete', null
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO




CREATE  trigger [dbo].[vtDDMFi] on [dbo].[vDDMF] for INSERT 
/*-----------------------------------------------------------------
 *	Created: GG 08/01/03
 *	Modified:
 *
 *	This trigger rejects insertion in vDDMF (Module Forms) if
 *	any of the following error conditions exist:
 *
 *		Invalid Module
 *		Invalid Form
 *
 */----------------------------------------------------------------

as
 


declare @errmsg varchar(255), @numrows int, @validcnt int

select @numrows = @@rowcount
if @numrows = 0 return

set nocount on
 
-- check Modules
select @validcnt = count(*)
from inserted i
join vDDMO m on m.Mod = i.Mod
if @validcnt <> @numrows
 	begin
 	select @errmsg = 'Invalid Module'
 	goto error
 	end
 
-- check Forms
select @validcnt = count(*)
from inserted i
join DDFHShared f on f.Form = i.Form
if @validcnt <> @numrows
 	begin
 	select @errmsg = 'Invalid Form'
 	goto error
 	end

return
 
error:
    select @errmsg = @errmsg + ' - cannot insert Module Form!'
    RAISERROR(@errmsg, 11, -1);
    rollback transaction
 
 





GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE TRIGGER [dbo].[vtDDMFi_Audit] ON [dbo].[vDDMF]
 AFTER INSERT
 NOT FOR REPLICATION AS
 SET NOCOUNT ON 
 -- generated by vspHQCreateAuditTriggers on May 14 2009  9:56AM

 BEGIN TRY 
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDMF' , '<KeyString Module = "' + REPLACE(CAST(inserted.Mod AS VARCHAR(MAX)),'"', '&quot;') + '" ModuleForm = "' + REPLACE(CAST(inserted.Form AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'A' , NULL , NULL , NULL , GETDATE() , HOST_NAME() , 'INSERT INTO dbo.[vDDMF] ([Mod], [Form]) VALUES (' + ISNULL('''' + REPLACE(CAST(Mod AS NVARCHAR(MAX)), '''' , '''''') + '''', 'NULL') + ',' + ISNULL('''' + REPLACE(CAST(Form AS NVARCHAR(MAX)), '''' , '''''') + '''', 'NULL')  + ')'
	FROM inserted
 END TRY 
 BEGIN CATCH 
   RAISERROR('Error in [dbo].[dbo.vtDDMFi_Audit] trigger', 16, 1 ) with log
 END CATCH 
GO
EXEC sp_settriggerorder N'[dbo].[vtDDMFi_Audit]', 'last', 'insert', null
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO





CREATE  trigger [dbo].[vtDDMFu] on [dbo].[vDDMF] for UPDATE 
/*-----------------------------------------------------------------
 * 	Created: GG 08/01/03
 *	Modified:
 *
 *	This trigger rejects update in vDDMF (Module Forms) if the
 *	following error condition exists:
 *
 *		Cannot change Module or Form
 *
 */----------------------------------------------------------------
as


declare @errmsg varchar(255), @numrows int, @validcnt int
 	 
select @numrows = @@rowcount
if @numrows = 0 return

set nocount on

 
/* check for key change */
select @validcnt = count(*) from inserted i
	join deleted d on i.Mod = d.Mod and i.Form = d.Form 
if @validcnt <> @numrows
 	begin
 	select @errmsg = 'Cannot change Module or Form'
 	goto error
 	end
 
return
 
error:
    select @errmsg = @errmsg + ' - cannot update Module Forms!'
    RAISERROR(@errmsg, 11, -1);
    rollback transaction
 







GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE TRIGGER [dbo].[vtDDMFu_Audit] ON [dbo].[vDDMF]
 AFTER UPDATE 
 NOT FOR REPLICATION AS 
 SET NOCOUNT ON 
 -- generated by vspHQCreateAuditTriggers on May 14 2009  9:56AM

 BEGIN TRY 
 IF UPDATE([Mod])
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDMF' , '<KeyString Module = "' + REPLACE(CAST(inserted.Mod AS VARCHAR(MAX)),'"', '&quot;') + '" ModuleForm = "' + REPLACE(CAST(inserted.Form AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'U' , 'Mod' ,  CONVERT(VARCHAR(MAX), deleted.[Mod]) ,  Convert(VARCHAR(MAX), inserted.[Mod]) , GETDATE() , HOST_NAME() , 'UPDATE vDDMF SET Mod = ''' + ISNULL(REPLACE(Convert(VARCHAR(MAX), inserted.[Mod]), '''' , ''''''), 'NULL') + ''' WHERE Mod = ''' + CAST(inserted.Mod AS VARCHAR(MAX)) + '''' + ' AND Form = ''' + CAST(inserted.Form AS VARCHAR(MAX)) + ''''
		FROM inserted
			INNER JOIN deleted
         ON  inserted.[Mod] = deleted.[Mod]  AND  inserted.[Form] = deleted.[Form] 
         AND ISNULL(inserted.[Mod],'') <> ISNULL(deleted.[Mod],'')

 IF UPDATE([Form])
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDMF' , '<KeyString Module = "' + REPLACE(CAST(inserted.Mod AS VARCHAR(MAX)),'"', '&quot;') + '" ModuleForm = "' + REPLACE(CAST(inserted.Form AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'U' , 'Form' ,  CONVERT(VARCHAR(MAX), deleted.[Form]) ,  Convert(VARCHAR(MAX), inserted.[Form]) , GETDATE() , HOST_NAME() , 'UPDATE vDDMF SET Form = ''' + ISNULL(REPLACE(Convert(VARCHAR(MAX), inserted.[Form]), '''' , ''''''), 'NULL') + ''' WHERE Mod = ''' + CAST(inserted.Mod AS VARCHAR(MAX)) + '''' + ' AND Form = ''' + CAST(inserted.Form AS VARCHAR(MAX)) + ''''
		FROM inserted
			INNER JOIN deleted
         ON  inserted.[Mod] = deleted.[Mod]  AND  inserted.[Form] = deleted.[Form] 
         AND ISNULL(inserted.[Form],'') <> ISNULL(deleted.[Form],'')

 END TRY 
 BEGIN CATCH 
   RAISERROR('Error in [dbo].[dbo.vtDDMFi_Audit] trigger', 16, 1 ) with log
 END CATCH 
GO
EXEC sp_settriggerorder N'[dbo].[vtDDMFu_Audit]', 'last', 'update', null
GO
CREATE UNIQUE CLUSTERED INDEX [viDDMF] ON [dbo].[vDDMF] ([Mod], [Form]) WITH (FILLFACTOR=90) ON [PRIMARY]
GO
