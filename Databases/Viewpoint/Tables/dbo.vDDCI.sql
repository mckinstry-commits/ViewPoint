CREATE TABLE [dbo].[vDDCI]
(
[ComboType] [varchar] (20) COLLATE Latin1_General_BIN NOT NULL,
[Seq] [smallint] NOT NULL,
[DisplayValue] [varchar] (100) COLLATE Latin1_General_BIN NOT NULL,
[DatabaseValue] [varchar] (30) COLLATE Latin1_General_BIN NOT NULL
) ON [PRIMARY]
CREATE UNIQUE CLUSTERED INDEX [viDDCI] ON [dbo].[vDDCI] ([ComboType], [Seq]) WITH (FILLFACTOR=90) ON [PRIMARY]

GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO




CREATE  trigger [dbo].[vtDDCId] on [dbo].[vDDCI] for DELETE
/************************************
* Created: MJ 1/11/05
* Modified: 
*
* Delete trigger on vDDCI (DD ComboTypeItems)
*
* Rejects deletion if any of the following conditions exist:
*	none
*
* Adds DD Audit entry
*
************************************/
as



declare @errmsg varchar(255)
  
if @@rowcount = 0 return
set nocount on

-- DD Audit 
insert dbo.vDDDA (TableName, Action, KeyString, FieldName,
	OldValue, NewValue, RevDate, UserName, HostName)
select 'vDDCI', 'D', 'ComboType: ' + rtrim(ComboType) + ' Seq: ' + convert(varchar,Seq), null,
	null, null, getdate(), SUSER_SNAME(), host_name()
from deleted
  
return

-- error not used 
error:
	select @errmsg = isnull(@errmsg,'') + ' - cannot delete ComboTypeItem!'
    RAISERROR(@errmsg, 11, -1);
    rollback transaction
  
  
  
  
 







GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE TRIGGER [dbo].[vtDDCId_Audit] ON [dbo].[vDDCI]
 AFTER DELETE
 NOT FOR REPLICATION AS
 SET NOCOUNT ON 
 -- generated by vspHQCreateAuditTriggers on May 14 2009  9:56AM

 BEGIN TRY 
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDCI' , '<KeyString ComboBoxType = "' + REPLACE(CAST(deleted.ComboType AS VARCHAR(MAX)),'"', '&quot;') + '" Seq = "' + REPLACE(CAST(deleted.Seq AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'D' , NULL , NULL , NULL , GETDATE() , HOST_NAME() , 'DELETE FROM vDDCI WHERE ComboType = ''' + CAST(deleted.ComboType AS VARCHAR(MAX)) + '''' + ' AND Seq = ''' + CAST(deleted.Seq AS VARCHAR(MAX)) + ''''
	FROM deleted
 END TRY 
 BEGIN CATCH 
   RAISERROR('Error in [dbo].[dbo.vtDDCIi_Audit] trigger', 16, 1 ) with log
 END CATCH 
GO
EXEC sp_settriggerorder N'[dbo].[vtDDCId_Audit]', 'last', 'delete', null
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO





CREATE  trigger [dbo].[vtDDCIi] on [dbo].[vDDCI] for INSERT
/*****************************
* Created: MJ 1/1/05
* Modified:
*
* Insert trigger on vDDCI (DD ComboTypeItems)
*
* Rejects insert if the following conditions exist:
*	Invalid ComboType
*
*
* Adds DD Audit entry
*
*************************************/

as


declare @errmsg varchar(255), @numrows int, @validcnt int, @nullcnt int
  
select @numrows = @@rowcount
if @numrows = 0 return

set nocount on

-- validate ComboItem
select @validcnt = count(*)
from inserted i
join dbo.vDDCB h with (nolock) on i.ComboType = h.ComboType
if @validcnt <> @numrows
  	begin
  	select @errmsg = 'Invalid ComboType - must exist in vDDCB'
  	goto error
  	end
-- validate Seq#
if exists(select top 1 1 from inserted where Seq < 0)
	begin
  	select @errmsg = 'Invalid Sequence# - must be equal to or greater than 0'
  	goto error
  	end

-- DD Audit  
insert vDDDA (TableName, Action, KeyString, FieldName, OldValue, 
  	NewValue, RevDate, UserName, HostName)
select 'vDDCI', 'I', 'ComboItem: ' + rtrim(ComboType) + ' Seq: ' + convert(varchar,Seq), null, null,
	null, getdate(), SUSER_SNAME(), host_name()
from inserted 
  	 	 	 
return

error:
	select @errmsg = isnull(@errmsg,'') + ' - cannot insert ComboTypeItem!'
  	RAISERROR(@errmsg, 11, -1);
  	rollback transaction
  
    






GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE TRIGGER [dbo].[vtDDCIi_Audit] ON [dbo].[vDDCI]
 AFTER INSERT
 NOT FOR REPLICATION AS
 SET NOCOUNT ON 
 -- generated by vspHQCreateAuditTriggers on May 14 2009  9:56AM

 BEGIN TRY 
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDCI' , '<KeyString ComboBoxType = "' + REPLACE(CAST(inserted.ComboType AS VARCHAR(MAX)),'"', '&quot;') + '" Seq = "' + REPLACE(CAST(inserted.Seq AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'A' , NULL , NULL , NULL , GETDATE() , HOST_NAME() , 'INSERT INTO dbo.[vDDCI] ([ComboType], [Seq], [DisplayValue], [DatabaseValue]) VALUES (' + ISNULL('''' + REPLACE(CAST(ComboType AS NVARCHAR(MAX)), '''' , '''''') + '''', 'NULL') + ',' + ISNULL(CAST(Seq AS NVARCHAR(MAX)), 'NULL') +  ',' + ISNULL('''' + REPLACE(CAST(DisplayValue AS NVARCHAR(MAX)), '''' , '''''') + '''', 'NULL') + ',' + ISNULL('''' + REPLACE(CAST(DatabaseValue AS NVARCHAR(MAX)), '''' , '''''') + '''', 'NULL')  + ')'
	FROM inserted
 END TRY 
 BEGIN CATCH 
   RAISERROR('Error in [dbo].[dbo.vtDDCIi_Audit] trigger', 16, 1 ) with log
 END CATCH 
GO
EXEC sp_settriggerorder N'[dbo].[vtDDCIi_Audit]', 'last', 'insert', null
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO





CREATE  trigger [dbo].[vtDDCIu] on [dbo].[vDDCI] for UPDATE
/************************************
* Created: MJ 1/11/05
* Modified: 
*
* Update trigger on vDDCI (DD ComboTypes Items)
*
* Rejects update if any of the following conditions exist:
*	Change ComboType name / Seq
*
* Adds DD Audit entries for changed values
*
************************************/

as


declare @errmsg varchar(255), @numrows int, @validcnt int 
  
select @numrows = @@rowcount
if @numrows = 0 return
set nocount on
  
-- check for key changes 
if update(ComboType) or update(Seq)
	begin
	select @validcnt = count(*)
	from inserted i
	join deleted d	on i.ComboType = d.ComboType and i.Seq = d.Seq
	if @validcnt <> @numrows
		begin
  		select @errmsg = 'Cannot change ComboType or Seq #'
  		goto error
  		end
	end
  	
-- DD Audit
if update(DisplayValue)
	insert dbo.vDDDA(TableName, Action, KeyString, FieldName,
		OldValue, NewValue, RevDate, UserName, HostName)
	select  'vDDCI', 'U', 'ComboType: ' + rtrim(i.ComboType) + ' Seq: ' + convert(varchar,i.Seq), 'DisplayValue',
		d.DisplayValue, i.DisplayValue, getdate(), SUSER_SNAME(), host_name()
  	from inserted i
  	join deleted d on i.ComboType = d.ComboType 
  	where i.DisplayValue <> d.DisplayValue

if update(DatabaseValue)
	insert dbo.vDDDA(TableName, Action, KeyString, FieldName,
		OldValue, NewValue, RevDate, UserName, HostName)
	select  'vDDCI', 'U', 'ComboType: ' + rtrim(i.ComboType) + ' Seq: ' + convert(varchar,i.Seq), 'DatabaseValue',
		d.DatabaseValue, i.DatabaseValue, getdate(), SUSER_SNAME(), host_name()
  	from inserted i
  	join deleted d on i.ComboType = d.ComboType 
  	where i.DatabaseValue <> d.DatabaseValue

return
  
error:
	select @errmsg = isnull(@errmsg,'') + ' - cannot update ComboType Item!'
    RAISERROR(@errmsg, 11, -1);
    rollback transaction
  
  
  
  
 







GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE TRIGGER [dbo].[vtDDCIu_Audit] ON [dbo].[vDDCI]
 AFTER UPDATE 
 NOT FOR REPLICATION AS 
 SET NOCOUNT ON 
 -- generated by vspHQCreateAuditTriggers on May 14 2009  9:56AM

 BEGIN TRY 
 IF UPDATE([ComboType])
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDCI' , '<KeyString ComboBoxType = "' + REPLACE(CAST(inserted.ComboType AS VARCHAR(MAX)),'"', '&quot;') + '" Seq = "' + REPLACE(CAST(inserted.Seq AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'U' , 'ComboType' ,  CONVERT(VARCHAR(MAX), deleted.[ComboType]) ,  Convert(VARCHAR(MAX), inserted.[ComboType]) , GETDATE() , HOST_NAME() , 'UPDATE vDDCI SET ComboType = ''' + ISNULL(REPLACE(Convert(VARCHAR(MAX), inserted.[ComboType]), '''' , ''''''), 'NULL') + ''' WHERE ComboType = ''' + CAST(inserted.ComboType AS VARCHAR(MAX)) + '''' + ' AND Seq = ''' + CAST(inserted.Seq AS VARCHAR(MAX)) + ''''
		FROM inserted
			INNER JOIN deleted
         ON  inserted.[ComboType] = deleted.[ComboType]  AND  inserted.[Seq] = deleted.[Seq] 
         AND ISNULL(inserted.[ComboType],'') <> ISNULL(deleted.[ComboType],'')

 IF UPDATE([Seq])
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDCI' , '<KeyString ComboBoxType = "' + REPLACE(CAST(inserted.ComboType AS VARCHAR(MAX)),'"', '&quot;') + '" Seq = "' + REPLACE(CAST(inserted.Seq AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'U' , 'Seq' ,  CONVERT(VARCHAR(MAX), deleted.[Seq]) ,  Convert(VARCHAR(MAX), inserted.[Seq]) , GETDATE() , HOST_NAME() , 'UPDATE vDDCI SET Seq = ''' + ISNULL(REPLACE(Convert(VARCHAR(MAX), inserted.[Seq]), '''' , ''''''), 'NULL') + ''' WHERE ComboType = ''' + CAST(inserted.ComboType AS VARCHAR(MAX)) + '''' + ' AND Seq = ''' + CAST(inserted.Seq AS VARCHAR(MAX)) + ''''
		FROM inserted
			INNER JOIN deleted
         ON  inserted.[ComboType] = deleted.[ComboType]  AND  inserted.[Seq] = deleted.[Seq] 
         AND ISNULL(inserted.[Seq],'') <> ISNULL(deleted.[Seq],'')

 IF UPDATE([DisplayValue])
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDCI' , '<KeyString ComboBoxType = "' + REPLACE(CAST(inserted.ComboType AS VARCHAR(MAX)),'"', '&quot;') + '" Seq = "' + REPLACE(CAST(inserted.Seq AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'U' , 'DisplayValue' ,  CONVERT(VARCHAR(MAX), deleted.[DisplayValue]) ,  Convert(VARCHAR(MAX), inserted.[DisplayValue]) , GETDATE() , HOST_NAME() , 'UPDATE vDDCI SET DisplayValue = ''' + ISNULL(REPLACE(Convert(VARCHAR(MAX), inserted.[DisplayValue]), '''' , ''''''), 'NULL') + ''' WHERE ComboType = ''' + CAST(inserted.ComboType AS VARCHAR(MAX)) + '''' + ' AND Seq = ''' + CAST(inserted.Seq AS VARCHAR(MAX)) + ''''
		FROM inserted
			INNER JOIN deleted
         ON  inserted.[ComboType] = deleted.[ComboType]  AND  inserted.[Seq] = deleted.[Seq] 
         AND ISNULL(inserted.[DisplayValue],'') <> ISNULL(deleted.[DisplayValue],'')

 IF UPDATE([DatabaseValue])
   INSERT dbo.vDDChangeLog (TableName, KeyString, Action, FieldName, OldValue, NewValue, DateTime, MachineName, CommandText)
   SELECT 'vDDCI' , '<KeyString ComboBoxType = "' + REPLACE(CAST(inserted.ComboType AS VARCHAR(MAX)),'"', '&quot;') + '" Seq = "' + REPLACE(CAST(inserted.Seq AS VARCHAR(MAX)),'"', '&quot;') + '" />' , 'U' , 'DatabaseValue' ,  CONVERT(VARCHAR(MAX), deleted.[DatabaseValue]) ,  Convert(VARCHAR(MAX), inserted.[DatabaseValue]) , GETDATE() , HOST_NAME() , 'UPDATE vDDCI SET DatabaseValue = ''' + ISNULL(REPLACE(Convert(VARCHAR(MAX), inserted.[DatabaseValue]), '''' , ''''''), 'NULL') + ''' WHERE ComboType = ''' + CAST(inserted.ComboType AS VARCHAR(MAX)) + '''' + ' AND Seq = ''' + CAST(inserted.Seq AS VARCHAR(MAX)) + ''''
		FROM inserted
			INNER JOIN deleted
         ON  inserted.[ComboType] = deleted.[ComboType]  AND  inserted.[Seq] = deleted.[Seq] 
         AND ISNULL(inserted.[DatabaseValue],'') <> ISNULL(deleted.[DatabaseValue],'')

 END TRY 
 BEGIN CATCH 
   RAISERROR('Error in [dbo].[dbo.vtDDCIi_Audit] trigger', 16, 1 ) with log
 END CATCH 
GO
EXEC sp_settriggerorder N'[dbo].[vtDDCIu_Audit]', 'last', 'update', null
GO
